# Minikube로 Kubenetes 로컬 환경 구성하기




## 1) WSL2 를 통한 Docker 개발환경 구성



Docker DeskTop이 유료가 되면서 회사 PC에서 로컬 테스트용으로 사용하던 것을 삭제해야했다.

그래서 Local환경을 Minikube를 사용해 Kubernetes를 쓸 수 있도록 셋팅하였고 과정을 정리해보려고한다!



#### 설치

WSL2는 기본으로 설치해야한다. WSL1이 깔려있어서 그냥 1으로 진행했는데 안됨.. 꼭 2로 시작하자!

[wsl2 설치](https://www.44bits.io/ko/post/wsl2-install-and-basic-usage)



#### wsl 에서 아래 명령어를 통해 패키지 관리자 업데이트 

```shell
$ sudo apt update
$ sudo apt upgrade
$ sudo apt install docker.io 
```



#### docker-ce  설치

```shell
$ sudo apt update 

# apt가 HTTPS를 통해 저장소를 사용할 수 있도록 패키지를 설치 
$ sudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common 

# 도커의 공식 GPG 키를 추가
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - 

# docker 저장소 설정
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu \ $(lsb_release -cs) stable" 

# docker-ce 최신버전 설치
$ sudo apt update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose 
```



#### docker 사용자 계정 부여

```shell
$ sudo groupadd docker

# $USER 에 본인 WSL 계정명을 입력
$ sudo usermod -aG docker $USER 
```



#### docker-ce 사설 리파지토리 설정

Docker Hub 는 기본 설정 되어 있고, 추가로 Nexus 주소를 넣어 넥서스에서도 Pull이 가능 하도록 설정 한다.
사설 리파지토리가 HTTPS인 경우 해당 리파지토리와 클라이언트에 추가 인증서 작업을 진행해야 한다. (HTTP 를 사용한다)

```shell
$ sudo vim /etc/docker/daemon.json 

# 아래 내용을 추가한다. 
{ 
  "insecure-registries": ["central.digitalkds.int:5000", "nexus-cip.digitalkds.int:5000"]
} 

# docker 서비스 재시작 
$ sudo service docker restart 

# docker 정보를 출력하고 하단의 insecure-repositories에 추가되었는지 확인한다. 
$ docker info 

# docker image 경로에 insecure-registries에 추가한 주소:포트가 추가되어야 한다. 
$ docker pull 주소:포트/hello-world:latest
```



## 2) Minikube 를 통한 Kubenetes 로컬 환경 구성



#### 설치

설치 전 WLS2 를 이용한 Docker 개발 환경 구성이 완료 되어 있어야 한다.

docker-ce 가 실행 상태여야 한다. 

```shell
mkdir minikubecd minikubecurl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64sudo install minikube-linux-amd64 /usr/local/bin/minikube

# 실행
minikube start

# 설치 확인
kubectl get pod -A

NAMESPACE   NAME                     READY  STATUS   RESTARTS    AGE
kube-system  coredns-78fcd69978-gjvrl         1/1   Running  0       93s
kube-system  etcd-minikube                 1/1   Running  0       105s
kube-system  kube-apiserver-minikube          1/1   Running  0       105s
kube-system  kube-controller-manager-minikube   1/1   Running  0       105s
kube-system  kube-proxy-2ptpr               1/1   Running  0       94s
kube-system  kube-scheduler-minikube          1/1   Running  0       105s
kube-system  storage-provisioner              1/1   Running  1 (63s ago)  104s


```



## 설치 중 겪었던 오류

#### 1) ImagePullBackOff

Warning  Failed   6m33s          kubelet       Failed to pull image "gitlab/gitlab-ce": rpc error: code = Unknown desc = Error response from daemon: Get "https://registry-1.docker.io/v2/": dial tcp: lookup registry-1.docker.io on 192.168.62.88:53: lame referral

DNS 추가

```shell
$ vi /etc/resolv.conf

# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.29.0.1

# 아래 2줄을 추가 한다.
nameserver 8.8.8.8
nameserver 8.8.4.4

# docker 서비스 재시작 
$ sudo service docker restart 
```



#### 2) 부팅시에 DNS 설정 초기화 방지

nameserver 는 WSL 이 재기동 되면 초기화 되기 때문에 초기화 방지를 위해서 아래 설정을 추가해준다!

```shell
# 파일이 없을 시에는 새롭게 생성해서 아래 내용을 붙여 넣기 한다.
sudo vim /etc/wsl.conf


automatically mount Windows drive when the distribution is launched
[automount]

# Set to true will automount fixed drives (C:/ or D:/) with DrvFs under the root directory set above. Set to false means drives won't be mounted automatically, but need to be mounted manually or with fstab.
enabled = true

# Sets the directory where fixed drives will be automatically mounted. This example changes the mount location, so your C-drive would be /c, rather than the default /mnt/c.
# root = /

# DrvFs-specific options can be specified.
# options = "metadata,uid=1003,gid=1003,umask=077,fmask=11,case=off"

# Sets the /etcfstab file to be processed when a WSL distribution is launched.
mountFsTab = true

# 아래 부분에 자동 생성을 false 로 변경했다. 
# Network host settings that enable the DNS server used by WSL 2. This example changes the hostname, sets generateHosts to false, preventing WSL from the default behavior of auto-generating /etc/hosts, and sets generateResolvConf to fals
e, preventing WSL from auto-generating /etc/resolv.conf, so that you can create your own (ie. nameserver 1.1.1.1).
[network]
#hostname = DemoHost
generateHosts = false
generateResolvConf = false

# Set whether WSL supports interop process like launching Windows apps and adding path variables. Setting these to false will block the launch of Windows processes and block adding $PATH environment variables.
[interop]
#enabled = false
#appendWindowsPath = false

# Set the user when launching a distribution with WSL.
[user]
#default = gill

# Set a command to run when a new WSL instance launches. This example starts the Docker container service. windows 11.
[boot]
# command = service docker start
```



#### 3) Windows 에서 Node Port 를 통한 접근

WSL2를 이용한 Kubernetes Service 는 Windows에서 바로 접근이 불가능 (WSL 상의 네트워크로 터널링 필요)

아래 Command 를 통해서 windows 에서 접근 가능하도록 자동 터널링을 해주며, 중지할 경우 터널링도 중지되니, 백그라운드로 실행

```shell
minikube service gitlab-service -n kronos-gitlab --url

# output으로 나온 port를 사용하여 브라우저로 접근
```


