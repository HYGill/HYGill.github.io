# 쿠버네티스 시작하기

- #### 모든 리소스는 오브젝트 형태로 관리됩니다.

  쿠버네티스에서는 컨테이너의 집합(Pods), 컨테이너의 집합을 관리하는 컨트롤러(Replica Set), 사용자(Service Account), 노드(Node)까지도 하나의 오브젝트로 취급

  > **kubectl api-resources** 명령어를 사용하면 오브젝트 종류 확인 가능
  >
  > **kubectl explain [특정 오브젝트 이름]** 특정 오브젝트의 간단한 설명 확인 가능



- #### 쿠버네티스는 여러 개의 컴포넌트로 구성돼 있습니다.

  > 모든 노드에서는 오버레이 네트워크 구성을 위해 프락시(kube-proxy)와 네트워크 플러그인(calico, flannel)이 실행

  1. **마스터 노드**  :  쿠버네티스가 제대로 동작할 수 있게 클러스터를 관리하는 역할을 담당

     > API 서버(kube-apiserver), 컨트롤러 매니저(kube-controller-manager), 
     >
     > 스케줄러(kube-scheduler), DNS서버(coreDNS)등 이 실행된다.

  2. **워커 노드** : 애플리케이션 컨테이너가 생성



- #### 포드(Pod) : 컨테이너를 다루는 기본 단위

  쿠버네티스에서는 컨테이너 애플리케이션의 기본 단위를 포드(Pod)라고 부르며, 포드는 1개 이상의 컨테이너로 구성된 컨테이너의 집합임. 즉, 여러 개의 컨테이너를 추상화해 하나의 애플리케이션으로 동작하도록 만드는 컨테이너 묶음인 것.

  여러 **리눅스 네임스페이스**를 공유하는 여러 컨테이너들을 추상화된 집합으로 사용한 것이 포드. 

  포드 내의 컨테이너들이 네트워크 네임스페이스 등과 같은 리눅스 네임스페이스를 공유해 사용

  > Pause 컨테이너는 네임스페이스를 공유하기 위해 포드별로 생성되는 컨테이너이며, 
  >
  > Pause 컨테이너는 각 포드에 대해 자동으로 생성



- #### 레플리카셋(Replica Set)

  일정 개수의 포드를 유지하는 컨트롤러

  실제로는 포드와 레플리카셋은 연결되어 있지 않고, 느슨한 연결을 유지하고 있는데 이런 느슨한 연결은 포드와 레플리카셋의 정의 중 라벨 셀렉터를 이용해 이뤄짐

  레플리카셋은 spec.selector.matchLael에 정의된 라벨을 통해 생성해야 하는 포드를 찾음

  > 레플리카셋과 포드의 라벨은 고유한 키-값 쌍이어야함

  레플리카셋은 포드를 생성하는 것이 아니라 **일정한 개수의 포드를 유지**하는 것이 목적



- #### 디플로이먼트(Deployment)

  레플리카셋의 상위 오브젝트. 

  디플로이먼트를 생성하면 일정 개수의 포드가 유지되도록 생성하는 것은 레플리카셋이기 때문에 함께 생성

  *왜 Deployment 개념이 생겨났을까*

  : 애플리케이션을 업데이트할 때 레플리카셋의 변경 사항을 저장하는 revision을 남겨 **롤백을 가능**하게 해주고 무중단 서비스를 위해 포드의 **롤링 업데이트 전략**을 지정할 수 있다.

  > kubectl apply -f [yaml파일 이름] --record (revision하는 방법)

  

- #### 서비스(Service)

  쿠버네티스는 디플로이먼트를 생성할 때 **포드를 외부로 노출하지 않으며**, 디플로이먼트의 YAML 파일에는 단지 포트의 애플리케이션이 사용할 내부 포트만 정의(containerPort) 하기 때문에 서비스라고 부르는 별도의 쿠버네티스 오브젝트 생성 후 배포.

  > 서비스의 라벨 셀렉터와 포드의 라벨이 매칭돼 연결되면 쿠버네티스는 자동으로 엔드포인트라고 부르는 오브젝트를 별도로 생성. 엔드포인트라는 이름이 의미하는 것처럼 엔드포인트 오브젝트는 서비스가 가리키고 있는 도착점을 나타냄

  **핵심 기능**

  1. 여러 개의 포드에 쉽게 접근할 수 있도록 고유한 도메인 이름을 부여

  2. 여러 개의 포드에 접근할 때 요청을 분산하는 로드 밸런서 기능 수행

  3. 클라우드 플랫폼의 로드 밸런서, 클러스터 노드의 포트 등을 통해 포드를 외부로 노출

     

  **서비스 타입**

  1. ClusterIP 타입 : 쿠버네티스 내부에서만 포드들에 접근할 때 사용. 외부로 포드를 노출하지 않음

  2. NodePort 타입 : 포드에 접근할 수 있는 **포트**를 클러스터의 **모든 노드에 동일하게 개방**. 접근할 수 있는 포트는 랜덤으로 정해지지만 특정 포트로 접근하도록 설정 가능

     > GKE, AWS에서 쿠버네티스를 사용하고 있는 경우, 각 노드의 랜덤한 포트에 접근하기 위해 별도로 방화벽 설정 추가

     - ClusterIP의 기능을 포함하고 있기 때문에 cluster내부에서는 내부 IP로도 접근 가능

  3. LoadBalancer 타입 : 클라우드 플랫폼에서 제공하는 로드 밸런서를 동적으로 프로비저닝해 포드에 연결. AWS, GCP 등과 같은 클라우드 플랫폼 환경에서만 사용 가능



